# nerdctl-docker-shim

[English](README.md)

ä¸€ä¸ªåŸºäº `nerdctl` çš„ Docker CLI å…¼å®¹æ€§åŒ…è£…è„šæœ¬ã€‚

æ­¤è„šæœ¬æ—¨åœ¨ä¸ºä¹ æƒ¯ä½¿ç”¨ Docker CLI æˆ–ä¾èµ–å®ƒçš„å·¥å…·ï¼ˆå¦‚ VS Code Dev Containersã€JetBrains IDE ç­‰ï¼‰æä¾›æ— ç¼çš„ `nerdctl` (containerd) ä½“éªŒã€‚å®ƒé€šè¿‡æ‹¦æˆª `docker` å‘½ä»¤å¹¶å°†å…¶è½¬æ¢ä¸ºç›¸åº”çš„ `nerdctl` å‘½ä»¤æ¥å®ç°å…¼å®¹æ€§ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### 1. Buildx æ„å»ºæ”¯æŒ

- **å‘½ä»¤æ¨¡æ‹Ÿ**ï¼šæ”¯æŒ `docker buildx version` å’Œ `docker buildx inspect`ï¼Œæ¬ºéª— IDE è®¤ä¸º Buildx å·²å°±ç»ªã€‚
- **å‚æ•°æ¸…ç†**ï¼šè‡ªåŠ¨è¿‡æ»¤æ‰ `nerdctl` å°šæœªæ”¯æŒçš„å‚æ•°ï¼Œé˜²æ­¢æ„å»ºå¤±è´¥ï¼š
  - `--builder`
  - `--load`
  - `--push`
  - `--provenance`
  - `--sbom`
- **æ—¥å¿—ä¼˜åŒ–**ï¼šå¼ºåˆ¶ä½¿ç”¨ `--progress=plain`ï¼Œç¡®ä¿æ„å»ºæ—¥å¿—èƒ½è¢« IDE æ­£ç¡®æ•è·å’Œæ˜¾ç¤ºã€‚
- **è¾“å‡ºæ¨¡æ‹Ÿ**ï¼šæ„å»ºå®Œæˆåï¼Œæ¨¡æ‹Ÿ Docker çš„æ ‡å‡†è¾“å‡ºï¼ˆä¾‹å¦‚ `naming to ... done`, `Loaded image: ...`ï¼‰ï¼Œç¡®ä¿å·¥å…·èƒ½æ­£ç¡®è§£æé•œåƒ IDã€‚

### 2. å®¹å™¨è¿è¡Œå¢å¼º

- **è‡ªåŠ¨å‘½å**ï¼šå½“æ‰§è¡Œ `docker run` æœªæŒ‡å®š `--name` æ—¶ï¼Œè‡ªåŠ¨æ³¨å…¥æ ¼å¼ä¸º `vsc-docker-<timestamp>` çš„åç§°ã€‚è¿™å¯¹æŸäº›éœ€è¦å®¹å™¨åç§°è¿›è¡Œç®¡ç†çš„ IDE æ’ä»¶éå¸¸æœ‰ç”¨ã€‚

### 3. å…¼å®¹æ€§ä¿®å¤

- **Inspect æ¨¡å¼**ï¼šæ‰§è¡Œ `docker inspect` æ—¶è‡ªåŠ¨æ·»åŠ  `--mode dockercompat` å‚æ•°ï¼Œç¡®ä¿è¿”å›çš„ JSON æ ¼å¼ä¸ Docker API ä¸€è‡´ã€‚
- **Context æ¨¡æ‹Ÿ**ï¼šæ”¯æŒ `docker context ls` å’Œ `docker context use`ï¼Œä¼ªé€ ä¸€ä¸ª `default` ä¸Šä¸‹æ–‡ä»¥æ»¡è¶³å·¥å…·æ£€æŸ¥è¦æ±‚ã€‚
- **Compose æ”¯æŒ**ï¼šç›´æ¥å°† `docker compose` å‘½ä»¤è½¬å‘ç»™ `nerdctl compose`ã€‚
- **å¼ºåˆ¶åˆ é™¤**ï¼šç›´æ¥è½¬å‘ `docker rm -f`ã€‚

### 4. è°ƒè¯•ä¸æ—¥å¿—

- **æ“ä½œæ—¥å¿—**ï¼šæ‰€æœ‰å‘½ä»¤è°ƒç”¨å’Œè½¬æ¢ç»†èŠ‚é»˜è®¤è®°å½•åœ¨ `/tmp/nerdctl-docker-shim.log` ä¸­ï¼Œä¾¿äºæ•…éšœæ’æŸ¥ã€‚

## âš™ï¸ é…ç½®

ä½ å¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡æ¥è°ƒæ•´è„šæœ¬çš„è¡Œä¸ºï¼š

| ç¯å¢ƒå˜é‡            | é»˜è®¤å€¼                         | æè¿°                                  |
| :------------------ | :----------------------------- | :------------------------------------ |
| `NERDCTL_BIN`       | `nerdctl` (è‡ªåŠ¨æ£€æµ‹)           | æŒ‡å®š `nerdctl` äºŒè¿›åˆ¶æ–‡ä»¶çš„å®é™…è·¯å¾„ã€‚ |
| `NERDCTL_NAMESPACE` | `default`                      | æŒ‡å®šä½¿ç”¨çš„ containerd å‘½åç©ºé—´ã€‚      |
| `DOCKER_SHIM_LOG`   | `/tmp/nerdctl-docker-shim.log` | æŒ‡å®šæ—¥å¿—æ–‡ä»¶çš„è¾“å‡ºè·¯å¾„ã€‚              |

## ğŸ“¦ å®‰è£…ä¸ä½¿ç”¨

### âš ï¸ é‡è¦ï¼šé˜²æ­¢è¦†ç›–

å¦‚æœä½ çš„ç³»ç»Ÿä¸Šå·²ç»å®‰è£…äº† Dockerï¼Œå»ºè®®å…ˆå¤‡ä»½åŸå§‹äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»¥é¿å…å†²çªæˆ–æ„å¤–è¦†ç›–ã€‚

```bash
# æŸ¥æ‰¾ç°æœ‰ docker å‘½ä»¤çš„ä½ç½®
which docker

# å¤‡ä»½ï¼ˆå‡è®¾å®ƒåœ¨ /usr/bin/dockerï¼‰
sudo mv /usr/bin/docker /usr/bin/docker.real
```

### å®‰è£…æ­¥éª¤

1. **ä¸‹è½½è„šæœ¬**

   ```bash
   curl -o docker https://raw.githubusercontent.com/kiddingbaby/nerdctl-docker-shim/main/docker
   chmod +x docker
   ```

1. **å®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„**

   å°†è„šæœ¬ç§»åŠ¨åˆ°ä½ çš„ `PATH` ä¸­çš„ç›®å½•ï¼ˆä¾‹å¦‚ `/usr/local/bin` æˆ– `/usr/bin`ï¼‰ã€‚ç¡®ä¿æ­¤ç›®å½•åœ¨ä½ çš„ `PATH` ä¸­å…·æœ‰è¶³å¤Ÿé«˜çš„ä¼˜å…ˆçº§ï¼Œæˆ–è€…ä½ å·²ç»ç§»é™¤äº†åŸå§‹çš„ `docker` å‘½ä»¤ã€‚

   ```bash
   sudo mv docker /usr/local/bin/docker
   ```

1. **éªŒè¯å®‰è£…**

   ```bash
   # ç¡®è®¤ docker å‘½ä»¤ç°åœ¨æŒ‡å‘ shim è„šæœ¬
   ls -l $(which docker)

   # éªŒè¯åŠŸèƒ½ï¼ˆåº”æ˜¾ç¤º nerdctl ç‰ˆæœ¬ä¿¡æ¯ï¼‰
   docker version
   ```

### ğŸ”§ `nerdctl` ç›¸å…³è®¾ç½®

æ­¤è„šæœ¬çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯å°† `docker` å‘½ä»¤â€œè½¬å‘â€ç»™ `nerdctl`ã€‚ä¸ºç¡®ä¿è½¬å‘æ­£å¸¸å·¥ä½œï¼š

1. **ç¡®ä¿å·²å®‰è£… `nerdctl`**ï¼šè„šæœ¬é»˜è®¤åœ¨ä½ çš„ `PATH` ä¸­æŸ¥æ‰¾ `nerdctl`ã€‚
2. **è‡ªå®šä¹‰è·¯å¾„**ï¼šå¦‚æœ `nerdctl` ä¸åœ¨ä½ çš„ `PATH` ä¸­ï¼Œæˆ–è€…ä½ æƒ³æŒ‡å®šç‰¹å®šçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¯·è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

   ```bash
   export NERDCTL_BIN=/path/to/your/nerdctl
   ```

## ğŸ§ª æµ‹è¯•

æœ¬é¡¹ç›®åŒ…å«ä¸¤ç§ç±»å‹çš„æµ‹è¯•ï¼š

1. **å•å…ƒæµ‹è¯•** (`tests/unit_test.sh`)ï¼šMock `nerdctl` ä»¥éªŒè¯å‚æ•°è§£æå’Œé€»è¾‘è½¬æ¢ã€‚ä¸éœ€è¦çœŸå®çš„å®¹å™¨ç¯å¢ƒã€‚
2. **é›†æˆæµ‹è¯•** (`tests/integration_test.sh`)ï¼šéœ€è¦çœŸå®çš„ `nerdctl` ç¯å¢ƒæ¥æ¨¡æ‹Ÿå®Œæ•´çš„ VS Code æ„å»ºå’Œè¿è¡Œæµç¨‹ã€‚
3. **Dev Container æ¨¡æ‹Ÿ** (`tests/simulate_devcontainer.sh`)ï¼šä½¿ç”¨çœŸå®çš„ `.devcontainer` é…ç½®è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼Œå¤åˆ¶ VS Code çš„è¡Œä¸ºã€‚

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
bash tests/unit_test.sh

# è¿è¡Œé›†æˆæµ‹è¯•
bash tests/integration_test.sh

# è¿è¡Œ Dev Container æ¨¡æ‹Ÿ
bash tests/simulate_devcontainer.sh
```

## ğŸ“ è„šæœ¬é€»è¾‘æ¦‚è§ˆ

```mermaid
graph TD
    A[è¾“å…¥ docker å‘½ä»¤] --> B{å‘½ä»¤ç±»å‹?};
    B -- buildx --> C[æ¸…ç†å‚æ•°/æ¨¡æ‹Ÿè¾“å‡º];
    B -- run --> D[æ£€æŸ¥/æ³¨å…¥ --name];
    B -- inspect --> E[æ·»åŠ  --mode dockercompat];
    B -- context --> F[è¿”å›ä¼ªé€  Context];
    B -- other --> G[é€ä¼ ç»™ nerdctl];
    C --> H[æ‰§è¡Œ nerdctl];
    D --> H;
    E --> H;
    G --> H;
```

#!/usr/bin/env bash
#
# ==============================================================================
# Docker CLI compatibility wrapper based on nerdctl
# ==============================================================================
#
# This script provides a Docker-compatible CLI entrypoint by delegating
# container operations to nerdctl (containerd).
#
# ==============================================================================

set -o pipefail

# ------------------------------------------------------------------------------
# Runtime configuration
# ------------------------------------------------------------------------------

NERDCTL_BIN="${NERDCTL_BIN:-$(command -v nerdctl)}"
NERDCTL_NAMESPACE="${NERDCTL_NAMESPACE:-default}"

LOG_FILE="${DOCKER_SHIM_LOG:-/tmp/nerdctl-docker-shim.log}"
BUILDX_VERSION="github.com/docker/buildx v0.11.2 9872040"

if [[ -z "$NERDCTL_BIN" || ! -x "$NERDCTL_BIN" ]]; then
    echo "docker: nerdctl not found" >&2
    exit 127
fi

mkdir -p "$(dirname "$LOG_FILE")" 2>/dev/null || true

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') [$$] docker $*" >>"$LOG_FILE"
}

log "CMD: $*"

# ------------------------------------------------------------------------------
# docker info (WSL 2 detection fix)
# ------------------------------------------------------------------------------

if [[ "$1" == "info" ]]; then
    is_json=false
    for arg in "$@"; do
        if [[ "$arg" == "--format" ]] && [[ "$@" == *"json"* ]]; then
            is_json=true
            break
        fi
    done

    if [[ "$is_json" == true ]]; then
        log "info --format json -> fake docker info"
        cat <<EOF
{
  "ID": "368a1414-4117-4201-a905-9a0d3e5b87ed",
  "Containers": 0,
  "ContainersRunning": 0,
  "ContainersPaused": 0,
  "ContainersStopped": 0,
  "Images": 0,
  "Driver": "overlayfs",
  "DriverStatus": [
    [
      "Backing Filesystem",
      "extfs"
    ]
  ],
  "Plugins": {
    "Volume": [
      "local"
    ],
    "Network": [
      "bridge",
      "host",
      "ipvlan",
      "macvlan",
      "null",
      "overlay"
    ],
    "Authorization": null,
    "Log": [
      "awslogs",
      "fluentd",
      "gcplogs",
      "gelf",
      "journald",
      "json-file",
      "local",
      "logentries",
      "splunk",
      "syslog"
    ]
  },
  "MemoryLimit": true,
  "SwapLimit": true,
  "KernelMemory": true,
  "CpuCfsPeriod": true,
  "CpuCfsQuota": true,
  "CPUShares": true,
  "CPUSet": true,
  "IPv4Forwarding": true,
  "BridgeNfIptables": true,
  "BridgeNfIp6tables": true,
  "Debug": false,
  "NFd": 22,
  "OomKillDisable": true,
  "NGoroutines": 42,
  "SystemTime": "$(date -Iseconds)",
  "LoggingDriver": "json-file",
  "CgroupDriver": "cgroupfs",
  "NEventsListener": 0,
  "KernelVersion": "6.6.87.2-microsoft-standard-WSL2",
  "OperatingSystem": "Docker Desktop",
  "OSType": "linux",
  "Architecture": "x86_64",
  "IndexServerAddress": "https://index.docker.io/v1/",
  "RegistryConfig": {
    "InsecureRegistryCIDRs": [
      "127.0.0.0/8"
    ],
    "IndexConfigs": {
      "docker.io": {
        "Name": "docker.io",
        "Mirrors": [],
        "Secure": true,
        "Official": true
      }
    },
    "Mirrors": []
  },
  "NCPU": 16,
  "MemTotal": 16664260608,
  "GenericResources": null,
  "DockerRootDir": "/var/lib/docker",
  "HttpProxy": "",
  "HttpsProxy": "",
  "NoProxy": "",
  "Name": "docker-desktop",
  "Labels": [],
  "ExperimentalBuild": false,
  "ServerVersion": "24.0.6",
  "ClusterStore": "",
  "ClusterAdvertise": "",
  "Runtimes": {
    "io.containerd.runc.v2": {
      "path": "runc"
    },
    "runc": {
      "path": "runc"
    }
  },
  "DefaultRuntime": "runc",
  "Swarm": {
    "NodeID": "",
    "NodeAddr": "",
    "LocalNodeState": "inactive",
    "ControlAvailable": false,
    "Error": "",
    "RemoteManagers": null
  },
  "LiveRestoreEnabled": false,
  "Isolation": "",
  "InitBinary": "docker-init",
  "ContainerdCommit": {
    "ID": "8165feabfdfe38c65b599c4993d227328c231fca",
    "Expected": "8165feabfdfe38c65b599c4993d227328c231fca"
  },
  "RuncCommit": {
    "ID": "v1.1.8-0-g82f18fe",
    "Expected": "v1.1.8-0-g82f18fe"
  },
  "InitCommit": {
    "ID": "de40ad0",
    "Expected": "de40ad0"
  },
  "SecurityOptions": [
    "name=seccomp,profile=default"
  ],
  "Warnings": null
}
EOF
        exit 0
    fi
fi

# ------------------------------------------------------------------------------
# docker buildx
# ------------------------------------------------------------------------------

if [[ "$1" == "buildx" ]]; then
    shift

    case "$1" in
    version)
        echo "$BUILDX_VERSION"
        exit 0
        ;;
    inspect)
        cat <<EOF
Name: default
Driver: docker-container
Nodes:
- Name: default
  Endpoint: unix:///var/run/docker.sock
EOF
        exit 0
        ;;
    build)
        shift

        args=()
        image_tag=""

        while [[ $# -gt 0 ]]; do
            case "$1" in
            --builder | --builder=*)
                [[ "$1" == "--builder" ]] && shift
                shift
                ;;
            --load | --push | --provenance=* | --sbom=*)
                log "Ignoring buildx flag: $1"
                shift
                ;;
            -t | --tag)
                args+=("$1" "$2")
                image_tag="$2"
                shift 2
                ;;
            -t=*)
                args+=("$1")
                image_tag="${1#*=}"
                shift
                ;;
            *)
                args+=("$1")
                shift
                ;;
            esac
        done

        temp_log="$(mktemp)"
        log "buildx build -> nerdctl build ${args[*]}"

        "$NERDCTL_BIN" \
            --namespace "$NERDCTL_NAMESPACE" \
            build \
            --progress=plain \
            "${args[@]}" \
            2>&1 | tee "$temp_log"

        exit_code=${PIPESTATUS[0]}

        if [[ $exit_code -eq 0 && -n "$image_tag" ]]; then
            digest=$(grep -oE "sha256:[a-f0-9]{64}" "$temp_log" | head -n1)
            digest="${digest:-sha256:fake$(date +%s)}"

            echo "naming to docker.io/library/$image_tag done"
            echo "writing image $digest done"
            echo "Loaded image: $image_tag"
        fi

        cat "$temp_log" >>"$LOG_FILE"
        rm -f "$temp_log"
        exit "$exit_code"
        ;;
    esac
fi

# ------------------------------------------------------------------------------
# docker compose
# ------------------------------------------------------------------------------

if [[ "$1" == "compose" ]]; then
    log "compose -> nerdctl compose"
    exec "$NERDCTL_BIN" --namespace "$NERDCTL_NAMESPACE" "$@"
fi

# ------------------------------------------------------------------------------
# docker inspect (JSON compatibility)
# ------------------------------------------------------------------------------

if [[ "$1" == "inspect" ]]; then
    shift
    log "inspect -> nerdctl inspect --mode=dockercompat"
    exec "$NERDCTL_BIN" --namespace "$NERDCTL_NAMESPACE" inspect --mode=dockercompat "$@"
fi

# ------------------------------------------------------------------------------
# docker rm -f
# ------------------------------------------------------------------------------

if [[ "$1" == "rm" && "$2" == "-f" ]]; then
    shift
    log "rm -f -> nerdctl rm -f"
    exec "$NERDCTL_BIN" --namespace "$NERDCTL_NAMESPACE" rm -f "$@"
fi

# ------------------------------------------------------------------------------
# docker run
# ------------------------------------------------------------------------------

if [[ "$1" == "run" ]]; then
    has_name=false
    for arg in "$@"; do
        [[ "$arg" == "--name" || "$arg" == --name=* ]] && has_name=true && break
    done

    if [[ "$has_name" == false ]]; then
        shift
        cname="vsc-docker-$(date +%s)-$RANDOM"
        log "run inject --name $cname"
        exec "$NERDCTL_BIN" --namespace "$NERDCTL_NAMESPACE" run --name "$cname" "$@"
    fi
fi

# ------------------------------------------------------------------------------
# docker context
# ------------------------------------------------------------------------------

if [[ "$1" == "context" ]]; then
    case "$2" in
    ls)
        cat <<EOF
NAME        DESCRIPTION                    DOCKER ENDPOINT
default *   nerdctl ($NERDCTL_NAMESPACE)   n/a
EOF
        exit 0
        ;;
    use)
        exit 0
        ;;
    esac
fi

# ------------------------------------------------------------------------------
# Default passthrough
# ------------------------------------------------------------------------------

log "passthrough -> nerdctl $*"
exec "$NERDCTL_BIN" --namespace "$NERDCTL_NAMESPACE" "$@"

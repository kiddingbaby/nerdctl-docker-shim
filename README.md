# nerdctl-docker-shim

ä¸€ä¸ªåŸºäº `nerdctl` çš„ Docker CLI å…¼å®¹æ€§åŒ…è£…è„šæœ¬ã€‚

è¯¥è„šæœ¬æ—¨åœ¨ä¸ºä¹ æƒ¯ä½¿ç”¨ Docker CLI æˆ–ä¾èµ– Docker CLI çš„å·¥å…·ï¼ˆå¦‚ VS Code Dev Containers, JetBrains IDEs ç­‰ï¼‰æä¾› `nerdctl` (containerd) çš„æ— ç¼ä½“éªŒã€‚å®ƒé€šè¿‡æ‹¦æˆª `docker` å‘½ä»¤å¹¶å°†å…¶è½¬æ¢ä¸ºå¯¹åº”çš„ `nerdctl` å‘½ä»¤æ¥å®ç°å…¼å®¹ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

### 1. Buildx æ„å»ºæ”¯æŒ

- **å‘½ä»¤æ¨¡æ‹Ÿ**: æ”¯æŒ `docker buildx version` å’Œ `docker buildx inspect`ï¼Œæ¬ºéª— IDE è®¤ä¸º Buildx å·²å°±ç»ªã€‚
- **å‚æ•°æ¸…æ´—**: è‡ªåŠ¨è¿‡æ»¤ `nerdctl` æš‚ä¸æ”¯æŒçš„å‚æ•°ï¼Œé˜²æ­¢æ„å»ºå¤±è´¥ï¼š
  - `--builder`
  - `--load`
  - `--push`
  - `--provenance`
  - `--sbom`
- **æ—¥å¿—ä¼˜åŒ–**: å¼ºåˆ¶ä½¿ç”¨ `--progress=plain`ï¼Œç¡®ä¿æ„å»ºæ—¥å¿—èƒ½è¢« IDE æ­£ç¡®æ•è·å’Œæ˜¾ç¤ºã€‚
- **è¾“å‡ºæ¨¡æ‹Ÿ**: æ„å»ºå®Œæˆåï¼Œæ¨¡æ‹Ÿ Docker çš„æ ‡å‡†è¾“å‡ºï¼ˆå¦‚ `naming to ... done`, `Loaded image: ...`ï¼‰ï¼Œç¡®ä¿å·¥å…·èƒ½æ­£ç¡®è§£æé•œåƒ IDã€‚

### 2. å®¹å™¨è¿è¡Œå¢å¼º

- **è‡ªåŠ¨å‘½å**: å½“æ‰§è¡Œ `docker run` æœªæŒ‡å®š `--name` æ—¶ï¼Œè‡ªåŠ¨æ³¨å…¥ `vsc-docker-<timestamp>` æ ¼å¼çš„åç§°ã€‚è¿™å¯¹äºæŸäº›éœ€è¦å®¹å™¨åç§°è¿›è¡Œç®¡ç†çš„ IDE æ’ä»¶éå¸¸æœ‰ç”¨ã€‚

### 3. å…¼å®¹æ€§ä¿®æ­£

- **Inspect æ¨¡å¼**: æ‰§è¡Œ `docker inspect` æ—¶è‡ªåŠ¨æ·»åŠ  `--mode dockercompat` å‚æ•°ï¼Œç¡®ä¿è¿”å›çš„ JSON æ ¼å¼ä¸ Docker API ä¿æŒä¸€è‡´ã€‚
- **Context æ¨¡æ‹Ÿ**: æ”¯æŒ `docker context ls` å’Œ `docker context use`ï¼Œä¼ªé€ ä¸€ä¸ª `default` ä¸Šä¸‹æ–‡ï¼Œæ»¡è¶³å·¥å…·æ£€æŸ¥éœ€æ±‚ã€‚
- **Compose æ”¯æŒ**: ç›´æ¥å°† `docker compose` å‘½ä»¤è½¬å‘ç»™ `nerdctl compose`ã€‚
- **å¼ºåˆ¶åˆ é™¤**: `docker rm -f` ç›´æ¥è½¬å‘ã€‚

### 4. è°ƒè¯•ä¸æ—¥å¿—

- **æ“ä½œæ—¥å¿—**: æ‰€æœ‰çš„å‘½ä»¤è°ƒç”¨å’Œè½¬æ¢ç»†èŠ‚é»˜è®¤è®°å½•åœ¨ `/tmp/nerdctl-docker-shim.log`ï¼Œæ–¹ä¾¿æ’æŸ¥é—®é¢˜ã€‚

## âš™ï¸ é…ç½®

ä½ å¯ä»¥é€šè¿‡è®¾ç½®ç¯å¢ƒå˜é‡æ¥è°ƒæ•´è„šæœ¬çš„è¡Œä¸ºï¼š

| ç¯å¢ƒå˜é‡            | é»˜è®¤å€¼                         | è¯´æ˜                                  |
| :------------------ | :----------------------------- | :------------------------------------ |
| `NERDCTL_BIN`       | `nerdctl` (è‡ªåŠ¨æŸ¥æ‰¾)           | æŒ‡å®š `nerdctl` äºŒè¿›åˆ¶æ–‡ä»¶çš„å®é™…è·¯å¾„ã€‚ |
| `NERDCTL_NAMESPACE` | `default`                      | æŒ‡å®šä½¿ç”¨çš„ containerd å‘½åç©ºé—´ã€‚      |
| `DOCKER_SHIM_LOG`   | `/tmp/nerdctl-docker-shim.log` | æŒ‡å®šæ—¥å¿—æ–‡ä»¶çš„è¾“å‡ºè·¯å¾„ã€‚              |

## ğŸ“¦ å®‰è£…ä½¿ç”¨

### âš ï¸ é‡è¦æç¤ºï¼šé˜²æ­¢è¦†ç›–

å¦‚æœä½ çš„ç³»ç»Ÿä¸­å·²ç»å®‰è£…äº† Dockerï¼Œå»ºè®®å…ˆå¤‡ä»½åŸå§‹çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œä»¥å…å‘ç”Ÿå†²çªæˆ–æ„å¤–è¦†ç›–ã€‚

```bash
# æŸ¥æ‰¾ç°æœ‰çš„ docker å‘½ä»¤ä½ç½®
which docker

# å¤‡ä»½ï¼ˆå‡è®¾åœ¨ /usr/bin/dockerï¼‰
sudo mv /usr/bin/docker /usr/bin/docker.real
```

### å®‰è£…æ­¥éª¤

1. **ä¸‹è½½è„šæœ¬**

   ```bash
   curl -o docker https://raw.githubusercontent.com/kiddingbaby/nerdctl-docker-shim/main/docker
   chmod +x docker
   ```

1. **å®‰è£…åˆ°ç³»ç»Ÿè·¯å¾„**

   å°†è„šæœ¬ç§»åŠ¨åˆ° `PATH` ä¸­çš„ç›®å½•ï¼ˆå¦‚ `/usr/local/bin` æˆ– `/usr/bin`ï¼‰ã€‚ç¡®ä¿è¯¥ç›®å½•åœ¨ `PATH` ä¸­çš„ä¼˜å…ˆçº§è¶³å¤Ÿé«˜ï¼Œæˆ–è€…ä½ å·²ç»ç§»é™¤äº†åŸæœ‰çš„ `docker` å‘½ä»¤ã€‚

   ```bash
   sudo mv docker /usr/local/bin/docker
   ```

1. **éªŒè¯å®‰è£…**

   ```bash
   # ç¡®è®¤ docker å‘½ä»¤ç°åœ¨æŒ‡å‘ shim è„šæœ¬
   ls -l $(which docker)

   # éªŒè¯åŠŸèƒ½ (åº”è¯¥æ˜¾ç¤º nerdctl çš„ç‰ˆæœ¬ä¿¡æ¯)
   docker version
   ```

### ğŸ”§ å…³äº `nerdctl` çš„å…³è”è®¾ç½®

æœ¬è„šæœ¬çš„æ ¸å¿ƒä½œç”¨å°±æ˜¯å°† `docker` å‘½ä»¤â€œè½¬å‘â€ç»™ `nerdctl`ã€‚ä¸ºäº†ç¡®ä¿è½¬å‘æ­£å¸¸å·¥ä½œï¼š

1. **ç¡®ä¿ `nerdctl` å·²å®‰è£…**: è„šæœ¬é»˜è®¤ä¼šåœ¨ `PATH` ä¸­æŸ¥æ‰¾ `nerdctl`ã€‚
2. **è‡ªå®šä¹‰è·¯å¾„**: å¦‚æœ `nerdctl` ä¸åœ¨ `PATH` ä¸­ï¼Œæˆ–è€…ä½ æƒ³æŒ‡å®šç‰¹å®šçš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè¯·è®¾ç½®ç¯å¢ƒå˜é‡ï¼š

   ```bash
   export NERDCTL_BIN=/path/to/your/nerdctl
   ```

## ğŸ§ª æµ‹è¯•

æœ¬é¡¹ç›®åŒ…å«ä¸¤ç±»æµ‹è¯•ï¼š

1. **å•å…ƒæµ‹è¯•** (`tests/unit_test.sh`): æ¨¡æ‹Ÿ `nerdctl`ï¼ŒéªŒè¯å‚æ•°è§£æå’Œé€»è¾‘è½¬æ¢ã€‚æ— éœ€çœŸå®å®¹å™¨ç¯å¢ƒã€‚
2. **é›†æˆæµ‹è¯•** (`tests/integration_test.sh`): éœ€è¦çœŸå®çš„ `nerdctl` ç¯å¢ƒï¼Œæ¨¡æ‹Ÿ VS Code çš„å®Œæ•´æ„å»ºå’Œè¿è¡Œæµç¨‹ã€‚
3. **Dev Container æ¨¡æ‹Ÿ** (`tests/simulate_devcontainer.sh`): ä½¿ç”¨çœŸå®çš„ `.devcontainer` é…ç½®è¿›è¡Œç«¯åˆ°ç«¯æµ‹è¯•ï¼Œè¿˜åŸ VS Code è¡Œä¸ºã€‚

```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
bash tests/unit_test.sh

# è¿è¡Œé›†æˆæµ‹è¯•
bash tests/integration_test.sh

# è¿è¡Œ Dev Container æ¨¡æ‹Ÿ
bash tests/simulate_devcontainer.sh
```

## ğŸ“ è„šæœ¬é€»è¾‘æ¦‚è§ˆ

```mermaid
graph TD
    A[è¾“å…¥ docker å‘½ä»¤] --> B{å‘½ä»¤ç±»å‹?};
    B -- buildx --> C[æ¸…æ´—å‚æ•°/æ¨¡æ‹Ÿè¾“å‡º];
    B -- run --> D[æ£€æŸ¥/æ³¨å…¥ --name];
    B -- inspect --> E[æ·»åŠ  --mode dockercompat];
    B -- context --> F[è¿”å›ä¼ªé€  Context];
    B -- å…¶ä»– --> G[ç›´æ¥é€ä¼ ç»™ nerdctl];
    C --> H[æ‰§è¡Œ nerdctl];
    D --> H;
    E --> H;
    G --> H;
```
